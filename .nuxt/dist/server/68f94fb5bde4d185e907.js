exports.ids=[3],exports.modules={58:function(t,e){t.exports={}},65:function(t,e,n){"use strict";n.r(e);var r=n(58),o=n.n(r);for(var d in r)"default"!==d&&function(t){n.d(e,t,(function(){return r[t]}))}(d);e.default=o.a},73:function(t,e,n){"use strict";n.r(e);n(55);var r=n(5),o=n(7),d=n(27);const l=n(4);var c={name:"visual",components:{BTaginput:d.a,BInput:o.a},async asyncData({$axios:t,params:e}){let n=null,r={};return"visual"!==e.id&&(n=await t.$get(`/task/boards/${e.id}/`),r.board=n.id),{flat_tasks:await t.$get("/task/tasks/",{params:r}),board:n}},data:()=>({startMove:!1,offset:[],movingTask:null,drawing:null,lines:{},settings:{},documentSize:{w:9e3,h:9e3},tasks:[],activeBoardUpdate:!1,boardF:null}),methods:{listenerDown(t){null===this.movingTask&&this.mouse_down({e:t})},listenerUp(t){this.startMove=!1,this.offset=[],this.movingTask=null},mouse_down({e:t,task:e}){this.movingTask=void 0===e?this.tasks[0]:e;let n=document.getElementById(`task-${this.movingTask.id}`).parentElement;this.startMove=!0,this.offset=[n.offsetLeft-t.clientX,n.offsetTop-t.clientY],this.draw(this.movingTask)},mouse_move(t){if(this.startMove&&this.movingTask){let e=document.getElementById(`task-${this.movingTask.id}`).parentElement;t.preventDefault();let n={x:t.clientX,y:t.clientY};void 0===this.settings[`T${this.movingTask.id}`]&&this.$set(this.settings,`T${this.movingTask.id}`,{});let r=n.x+this.offset[0],o=n.y+this.offset[1];if(this.$set(this.settings[`T${this.movingTask.id}`],"left",r),this.$set(this.settings[`T${this.movingTask.id}`],"top",o),n.x<=0||n.y<=0)return;e.style.left=r+"px",e.style.top=o+"px",this.draw(this.movingTask)}},draw(t){if(null===document.getElementById(`task-${t.id}`))return;let line=this.lines[`task-${t.id}`],e=document.getElementById(`task-${t.id}`).parentElement;if("number"==typeof t.parent){let n=document.getElementById(`task-${t.parent}`).parentElement,r=this.getOffset(n),o=this.getOffset(e),d=this.settings[`T${t.id}`],l=d?d.p1c:5,c=d?d.p2c:1,h=d?d.arrow:"bottom",v=!!d&&d.vertical;o.center.x<r.points[0].x?o.center.y>r.points[0].y&&o.center.y<r.points[6].y&&(v=!1,l=7,c=3):o.center.x>r.points[0].x&&o.center.x<r.points[2].x?o.center.y<r.points[0].y?(v=!0,l=1,c=5):o.center.y>r.points[6].y&&(v=!0,l=5,c=1):o.center.y>r.points[0].y&&o.center.y<r.points[6].y&&(l=3,c=7,v=!1);let f=r.points[l],m=o.points[c],$={x:v?f.x:r.center.x+.5*(o.center.x-r.center.x),y:v?r.center.y+.5*(o.center.y-r.center.y):f.y},_={x:v?m.x:r.center.x+.5*(o.center.x-r.center.x),y:v?r.center.y+.5*(o.center.y-r.center.y):m.y};void 0===this.settings[`T${t.id}`]&&this.$set(this.settings,`T${t.id}`,{}),this.$set(this.settings[`T${t.id}`],"p1c",l),this.$set(this.settings[`T${t.id}`],"p2c",c),this.$set(this.settings[`T${t.id}`],"arrow",h),this.$set(this.settings[`T${t.id}`],"vertical",v),line&&line.remove(),this.lines[`task-${t.id}`]=this.drawing.path(`M ${f.x} ${f.y} L${$.x} ${$.y} L${_.x} ${_.y} L${m.x} ${m.y}`).stroke({color:"#cccccc",width:2,linecap:"round",dasharray:8.3}).fill("transparent"),this.lines[`task-${t.id}`].attr("marker-end",`url(#arrow-${h})`)}t.children&&t.children.forEach(t=>{this.draw(t)})},initDraw(t){t&&t.forEach(t=>{this.draw(t),this.initDraw(t.children)})},saveSetting:l.debounce((function(){this.board?this.$axios.$put(`/task/boards/${this.board.slug}/`,{task_graph_setting:this.settings}):this.$axios.$put(`/auth/users/${this.currentUser.username}/`,{task_graph_setting:this.settings}).then(()=>{this.$store.commit("config/SET_SETTING_GRAPH",l.cloneDeep(this.settings))})}),1e3),async handle_add_child(t){let e=await this.$axios.$post("/task/tasks/",t);this.flat_tasks.push(e),this.init(),null===this.board&&(e=new r.a(e),await this.$store.commit("task/ADD_TASK",e),null===this.currentUser&&await this.$indexedDB.add(e))},async handle_delete_task(t){const e=(t,n)=>(n.push(t),t.children&&t.children.forEach(t=>{n.concat(e(t,n))}),n);let n=e(t,[]);for(let i=0;i<n.length;i++){let t=n[i];i>0&&await this.$axios.$delete(`/task/tasks/${t.id}/`);let e=this.flat_tasks.map(t=>t.id).indexOf(t.id);if(e>=0){this.lines[`task-${t.id}`].remove(),this.flat_tasks.splice(e,1)}}},init(){this.flat_tasks.forEach(t=>{t.temp_setting=this.settings[`T${t.id}`]});let t=this.hierarchy(this.flat_tasks,{idKey:"id",parentKey:"parent"});t.forEach(t=>t.parent=0);let e=new r.a({id:0,temp_setting:this.settings.T0,title:this.board?this.board.title:"Workspace",board:this.board?this.board.id:void 0});e.children=t,this.tasks=[e]},saveBoard(){let data={};["title","description","slug","text_tags","is_interface"].forEach(t=>{data[t]=this.boardF[t]}),this.currentUser&&this.currentUser.id===this.board.user&&this.$axios.$put(`/task/boards/${this.board.slug}/`,data).then(t=>{this.boardF=null,t.slug!==this.board.slug&&this.$router.replace({path:`/template/${t.slug}`}),this.board=t,this.tasks[0].title=t.title}).finally(()=>{this.activeBoardUpdate=!1})},openBoardModal(){this.board&&(this.boardF=l.cloneDeep(this.board),this.activeBoardUpdate=!0)}},mounted(){0},watch:{settings:{deep:!0,handler:function(){this.saveSetting()}},flat_tasks:{deep:!0,handler:function(){this.init(),this.initDraw(this.tasks)}}},created(){this.board?this.settings=this.board.settings?this.board.settings.task_graph_setting:{}:this.settings=this.$store.state.config.settings.task_graph_setting?l.cloneDeep(this.$store.state.config.settings.task_graph_setting):{},this.init()},beforeDestroy(){document.removeEventListener("mousedown",this.listenerDown),document.removeEventListener("mouseup",this.listenerUp),document.removeEventListener("mousemove",this.mouse_move)}},h=n(1);var component=Object(h.a)(c,(function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{ref:"visual",staticClass:"visual",attrs:{id:"visual"}},[t._ssrNode('<div id="vs-background" class="background"></div> '),t._ssrNode('<div class="wrapper">',"</div>",t._l(t.tasks,(function(e){return n("task-graph",{key:e.id,attrs:{readonly:"",value:e},on:{down:t.mouse_down,add:t.handle_add_child,"board-update":t.openBoardModal,deleted:t.handle_delete_task}})})),1),t._ssrNode(" "),n("b-modal",{attrs:{active:t.activeBoardUpdate,scroll:"keep"},on:{"update:active":function(e){t.activeBoardUpdate=e}}},[n("div",{staticClass:"modal-card",staticStyle:{width:"auto"}},[n("header",{staticClass:"modal-card-head"},[n("div",{staticClass:"level is-mobile",staticStyle:{width:"100%"}},[n("h4",{staticClass:"level-left"},[t._v("Board Setting")]),t._v(" "),n("div",{staticClass:"level-right"},[n("button",{staticClass:"button is-small",attrs:{type:"button"},on:{click:function(e){t.activeBoardUpdate=!1}}},[t._v("Cancel\n                        ")])])])]),t._v(" "),n("section",{staticClass:"modal-card-body"},[t.boardF?n("div",[n("div",{staticClass:"field"},[n("ce",{staticClass:"title",attrs:{elm:"h1",placeholder:"Board title"},model:{value:t.boardF.title,callback:function(e){t.$set(t.boardF,"title",e)},expression:"boardF.title"}})],1),t._v(" "),n("div",{staticClass:"field"},[n("b-input",{attrs:{placeholder:"Board title"},model:{value:t.boardF.slug,callback:function(e){t.$set(t.boardF,"slug",e)},expression:"boardF.slug"}})],1),t._v(" "),n("div",{staticClass:"field"},[n("ce",{staticClass:"notification is-light",attrs:{elm:"div",placeholder:"description"},model:{value:t.boardF.description,callback:function(e){t.$set(t.boardF,"description",e)},expression:"boardF.description"}})],1),t._v(" "),n("div",{staticClass:"field"},[n("b-switch",{model:{value:t.boardF.is_interface,callback:function(e){t.$set(t.boardF,"is_interface",e)},expression:"boardF.is_interface"}},[t._v("Template")])],1),t._v(" "),n("div",{staticClass:"field"},[n("b-taginput",{attrs:{placeholder:"Hash tag"},model:{value:t.boardF.text_tags,callback:function(e){t.$set(t.boardF,"text_tags",e)},expression:"boardF.text_tags"}})],1)]):t._e()]),t._v(" "),n("footer",{staticClass:"modal-card-foot"},[n("button",{staticClass:"button is-primary",on:{click:t.saveBoard}},[t._v("Save")])])])])],2)}),[],!1,(function(t){var e=n(65);e.__inject__&&e.__inject__(t)}),null,"6e0a4140");e.default=component.exports}};